@page "/"
@using Maanfee.Lottie;
@using Microsoft.AspNetCore.Components
@inject LottieService Lottie
@inject AnimationService AnimationService

@* https://creattie.com/lottie-animated-illustrations/all?type=free&orderBy=order&page=1 *@
@* https://icon-icons.com/pack/University/4302 *@

<PageTitle>Home</PageTitle>

<style>
    .lottie-container {
        width: 100%;
        height: 300px;
        margin: 1rem 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
    }

    .lottie-animation {
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .controls {
        margin: 1rem 0;
        text-align: center;
    }

        .controls button {
            margin: 0 0.5rem;
        }

    .dropdown-container {
        margin: 1rem 0;
        text-align: center;
    }

    .dropdown {
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 1rem;
        width: 300px;
    }
</style>

<div class="dropdown-container">
    <select id="animationSelect" class="dropdown" @onchange="OnAnimationSelected">
        <option value="">Select File</option>
        @foreach (var item in AvailableAnimations)
        {
            <option value="@item.FullPath">@item.Name</option>
        }
    </select>
</div>

<LottieContainer AnimationJson="@content" OnLoaded="OnLoadingLoaded" @key="SelectedAnimation.FullPath" />

@* <LottieContainer AnimationUrl="Anim/business-analysis.json" OnLoaded="OnLoadingLoaded" @key="SelectedAnimation.FullPath" /> *@

<div class="controls">
    <button @onclick="Play" class="btn btn-primary">Play</button>
    <button @onclick="Pause" class="btn btn-warning">Pause</button>
    <button @onclick="RandomAnimation" class="btn btn-success">Random</button>
</div>

@code {

    protected override async Task OnInitializedAsync()
    {
        AvailableAnimations = AnimationService.GetAvailableAnimations();
        await Task.Delay(100);
    }

    private AnimationInfo SelectedAnimation = new();

    private List<AnimationInfo> AvailableAnimations = new();

    private string content = string.Empty;

    // private List<string> AvailableAnimations = new List<string>
    // {
    //     "BusinessMeeting",
    //     "AnalyzingInfographics",
    //     "Assignees",
    //     "BuildingConstruction",
    //     "ColleagueSupport",
    //     "CryptoSaving",
    //     "DashboardComponents",
    //     "DataBreach",
    //     "DataLossPrevention",
    //     "DecisionMaking",
    //     "GraphicChart",
    //     "HeavyEquipment",
    //     "IceFishing",
    //     "Lighthouse",
    //     "Loading",
    //     "MachineryProduction",
    //     "RoboticsStudents",
    //     "Stonemason",
    //     "TechAssistant",
    //     "WebsiteTrafficData",
    //     "WorkingwithCobot",
    // };

    // private void OnAnimationSelected(ChangeEventArgs e)
    // {
    //     var selected = e.Value?.ToString();
    //     if (!string.IsNullOrEmpty(selected))
    //     {
    //         SelectedAnimation = selected;
    //         StateHasChanged();
    //     }
    // }

    private async Task OnAnimationSelected(ChangeEventArgs e)
    {
        var fullPath = e.Value?.ToString();
        if (!string.IsNullOrEmpty(fullPath))
        {
            var selectedAnimation = AvailableAnimations.FirstOrDefault(a => a.FullPath == fullPath);
            if (selectedAnimation != null)
            {
                await LoadAnimation(selectedAnimation);
            }
        }
    }

    private async Task LoadAnimation(AnimationInfo animationInfo)
    {
        content = await AnimationService.GetAnimationContentAsync(animationInfo.Name);
        SelectedAnimation = animationInfo;
        StateHasChanged();
    }

    private void OnLoadingLoaded()
    {
        Console.WriteLine("Loading animation loaded!");
    }

    private async Task Play()
    {
        if (Lottie != null)
        {
            await Lottie.Play();
        }
    }

    private async Task Pause()
    {
        if (Lottie != null)
            await Lottie.Pause();
    }

    private Random random = new Random();

    private async Task RandomAnimation()
    {
        if (AvailableAnimations == null || !AvailableAnimations.Any())
            return;

        var availableOptions = AvailableAnimations
            .Where(anim => anim.Name != SelectedAnimation?.Name)
            .ToList();

        if (!availableOptions.Any())
            availableOptions = AvailableAnimations.ToList();

        var randomIndex = random.Next(availableOptions.Count);
        await LoadAnimation(availableOptions[randomIndex]);
    }
}